# ============================================================================
# Erynoa P2P Testnet - Development Mode mit Hot-Reloading
# ============================================================================
#
# HOT-RELOADING AKTIVIERT!
# Änderungen am Source-Code werden automatisch erkannt und der Service
# wird neu kompiliert und gestartet.
#
# Verwendung:
#   docker compose -f infra/docker/docker-compose.testnet.dev.yml up
#   # Oder nur einen Node starten:
#   docker compose -f infra/docker/docker-compose.testnet.dev.yml up relay1
#
# Vorteile:
#   - Kein docker build bei Code-Änderungen nötig
#   - Automatisches Neukompilieren bei Dateiänderungen
#   - Schnellere Entwicklungszyklen
#   - Shared Cargo Registry für schnellere Builds
#
# Features aktiviert:
#   - p2p: Core P2P Stack (libp2p, Kademlia, Gossipsub, NAT-Traversal)
#   - privacy-full: Alle Privacy-Layer (Onion, Mixing, ZK, HW-Accel)
#
# ============================================================================

name: erynoa-testnet-dev

services:
  relay1:
    image: erynoa/testnet-node:latest
    container_name: erynoa-relay1-dev
    hostname: relay1
    networks:
      testnet:
        ipv4_address: 172.28.0.10
    ports:
      - "4001:4001"
      - "9101:9000"
    environment:
      RUST_LOG: "erynoa=debug,libp2p_gossipsub=info,libp2p_kad=info,libp2p_mdns=info,info"
      RUST_BACKTRACE: "1"
      APP_STORAGE__DATA_DIR: "/data"
      NODE_NAME: relay1
      NODE_MODE: relay
      P2P_PORT: "4001"
      API_PORT: "9000"
      BOOTSTRAP_PEERS: ""
      GENESIS_NODE: "true"
      P2P_ENABLE_MDNS: "true"
      # Hot-Reload Modus aktivieren
      DEV_MODE: "true"
      # Privacy-Full Feature aktivieren
      CARGO_FEATURES: "privacy-full"
    volumes:
      # Source-Code Mount für Hot-Reloading
      - ../../backend/src:/workspace/backend/src:ro
      - ../../backend/config:/workspace/backend/config:ro
      - ../../backend/Cargo.toml:/workspace/backend/Cargo.toml:ro
      - ../../backend/Cargo.lock:/workspace/backend/Cargo.lock:ro
      - ../../backend/build.rs:/workspace/backend/build.rs:ro
      # Shared Cargo Cache für schnellere Builds
      - cargo-registry:/usr/local/cargo/registry
      - cargo-git:/usr/local/cargo/git
      - target-cache:/workspace/backend/target
      # Data Volume
      - relay1-data:/data
    working_dir: /workspace/backend
    entrypoint: ["/entrypoint-dev.sh"]
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:9000/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 180s

  relay2:
    image: erynoa/testnet-node:latest
    container_name: erynoa-relay2-dev
    hostname: relay2
    depends_on:
      relay1:
        condition: service_started
    networks:
      testnet:
        ipv4_address: 172.28.0.11
    ports:
      - "4002:4001"
      - "9102:9000"
    environment:
      RUST_LOG: "erynoa=debug,libp2p_gossipsub=info,libp2p_kad=info,libp2p_mdns=info,info"
      RUST_BACKTRACE: "1"
      APP_STORAGE__DATA_DIR: "/data"
      NODE_NAME: relay2
      NODE_MODE: relay
      P2P_PORT: "4001"
      API_PORT: "9000"
      BOOTSTRAP_PEERS: "/ip4/172.28.0.10/tcp/4001"
      P2P_ENABLE_MDNS: "true"
      DEV_MODE: "true"
      CARGO_FEATURES: "privacy-full"
    volumes:
      - ../../backend/src:/workspace/backend/src:ro
      - ../../backend/config:/workspace/backend/config:ro
      - ../../backend/Cargo.toml:/workspace/backend/Cargo.toml:ro
      - ../../backend/Cargo.lock:/workspace/backend/Cargo.lock:ro
      - ../../backend/build.rs:/workspace/backend/build.rs:ro
      - cargo-registry:/usr/local/cargo/registry
      - cargo-git:/usr/local/cargo/git
      - target-cache:/workspace/backend/target
      - relay2-data:/data
    working_dir: /workspace/backend
    entrypoint: ["/entrypoint-dev.sh"]
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:9000/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 180s

  relay3:
    image: erynoa/testnet-node:latest
    container_name: erynoa-relay3-dev
    hostname: relay3
    depends_on:
      relay1:
        condition: service_started
    networks:
      testnet:
        ipv4_address: 172.28.0.12
    ports:
      - "4003:4001"
      - "9103:9000"
    environment:
      RUST_LOG: "erynoa=debug,libp2p_gossipsub=info,libp2p_kad=info,libp2p_mdns=info,info"
      RUST_BACKTRACE: "1"
      APP_STORAGE__DATA_DIR: "/data"
      NODE_NAME: relay3
      NODE_MODE: relay
      P2P_PORT: "4001"
      API_PORT: "9000"
      BOOTSTRAP_PEERS: "/ip4/172.28.0.10/tcp/4001"
      P2P_ENABLE_MDNS: "true"
      DEV_MODE: "true"
      CARGO_FEATURES: "privacy-full"
    volumes:
      - ../../backend/src:/workspace/backend/src:ro
      - ../../backend/config:/workspace/backend/config:ro
      - ../../backend/Cargo.toml:/workspace/backend/Cargo.toml:ro
      - ../../backend/Cargo.lock:/workspace/backend/Cargo.lock:ro
      - ../../backend/build.rs:/workspace/backend/build.rs:ro
      - cargo-registry:/usr/local/cargo/registry
      - cargo-git:/usr/local/cargo/git
      - target-cache:/workspace/backend/target
      - relay3-data:/data
    working_dir: /workspace/backend
    entrypoint: ["/entrypoint-dev.sh"]
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:9000/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 180s

  client:
    image: erynoa/testnet-node:latest
    container_name: erynoa-client-dev
    hostname: client
    depends_on:
      relay1:
        condition: service_started
      relay2:
        condition: service_started
      relay3:
        condition: service_started
    networks:
      testnet:
        ipv4_address: 172.28.0.20
    ports:
      - "4004:4001"
      - "9104:9000"
    environment:
      RUST_LOG: "erynoa=debug,libp2p_gossipsub=info,libp2p_kad=info,libp2p_mdns=info,info"
      RUST_BACKTRACE: "1"
      APP_STORAGE__DATA_DIR: "/data"
      NODE_NAME: client
      NODE_MODE: client
      P2P_PORT: "4001"
      API_PORT: "9000"
      BOOTSTRAP_PEERS: "/ip4/172.28.0.10/tcp/4001,/ip4/172.28.0.11/tcp/4001,/ip4/172.28.0.12/tcp/4001"
      P2P_ENABLE_MDNS: "true"
      DEV_MODE: "true"
      CARGO_FEATURES: "privacy-full"
    volumes:
      - ../../backend/src:/workspace/backend/src:ro
      - ../../backend/config:/workspace/backend/config:ro
      - ../../backend/Cargo.toml:/workspace/backend/Cargo.toml:ro
      - ../../backend/Cargo.lock:/workspace/backend/Cargo.lock:ro
      - ../../backend/build.rs:/workspace/backend/build.rs:ro
      - cargo-registry:/usr/local/cargo/registry
      - cargo-git:/usr/local/cargo/git
      - target-cache:/workspace/backend/target
      - client-data:/data
    working_dir: /workspace/backend
    entrypoint: ["/entrypoint-dev.sh"]
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:9000/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 180s

networks:
  testnet:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.28.0.0/16

volumes:
  relay1-data:
  relay2-data:
  relay3-data:
  client-data:
  # Shared volumes für schnellere Builds
  cargo-registry:
  cargo-git:
  target-cache:
