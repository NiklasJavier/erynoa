# ============================================================================
# Erynoa P2P Testnet - Multi-Node Docker Compose
# ============================================================================
#
# ğŸŒ 4-Node Testnetzwerk fÃ¼r P2P-Entwicklung
#
# Architektur:
#   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#   â”‚                      erynoa-testnet (Bridge Network)               â”‚
#   â”‚                                                                     â”‚
#   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
#   â”‚   â”‚ relay1  â”‚â—„â”€â”€â”€â–ºâ”‚ relay2  â”‚â—„â”€â”€â”€â–ºâ”‚ relay3  â”‚â—„â”€â”€â”€â–ºâ”‚ client  â”‚    â”‚
#   â”‚   â”‚ :4001   â”‚     â”‚ :4002   â”‚     â”‚ :4003   â”‚     â”‚ :4004   â”‚    â”‚
#   â”‚   â”‚ :9001   â”‚     â”‚ :9002   â”‚     â”‚ :9003   â”‚     â”‚ :9004   â”‚    â”‚
#   â”‚   â”‚ GENESIS â”‚     â”‚         â”‚     â”‚         â”‚     â”‚         â”‚    â”‚
#   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
#   â”‚        â–³               â”‚               â”‚               â”‚         â”‚
#   â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
#   â”‚                     Bootstrap via relay1                          â”‚
#   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# Verwendung:
#   # Starten
#   docker compose -f infra/docker/docker-compose.testnet.yml up -d
#
#   # Logs anzeigen
#   docker compose -f infra/docker/docker-compose.testnet.yml logs -f
#
#   # Einzelnen Node-Logs
#   docker compose -f infra/docker/docker-compose.testnet.yml logs -f relay1
#
#   # Stoppen
#   docker compose -f infra/docker/docker-compose.testnet.yml down
#
#   # Komplett neu bauen
#   docker compose -f infra/docker/docker-compose.testnet.yml up -d --build
#
# ============================================================================

name: erynoa-testnet

# ===========================================================================
# Shared Configuration (YAML Anchors)
# ===========================================================================
x-common-env: &common-env
  RUST_LOG: "erynoa_api=debug,libp2p_gossipsub=info,libp2p_kad=info,libp2p_mdns=debug,info"
  RUST_BACKTRACE: "1"
  # Storage-Pfad im Container
  APP_STORAGE__DATA_DIR: "/data"

x-common-volumes: &common-volumes # Source-Code fÃ¼r Hot-Reloading
  - ../../backend/src:/workspace/backend/src:cached
  - ../../backend/Cargo.toml:/workspace/backend/Cargo.toml:cached
  - ../../backend/Cargo.lock:/workspace/backend/Cargo.lock:cached
  - ../../backend/config:/workspace/backend/config:cached
  - ../../backend/build.rs:/workspace/backend/build.rs:cached
  # Proto-Files
  - ../../backend/proto:/workspace/backend/proto:cached
  - ../../buf.gen.yaml:/workspace/buf.gen.yaml:cached
  - ../../buf.yaml:/workspace/buf.yaml:cached
  # Generated Code
  - ../../backend/src/gen:/workspace/backend/src/gen:cached

x-common-build: &common-build
  context: ../..
  dockerfile: infra/docker/Dockerfile.testnet

x-healthcheck: &healthcheck
  test: ["CMD", "curl", "-f", "http://localhost:${API_PORT:-9000}/health"]
  interval: 10s
  timeout: 5s
  retries: 3
  start_period: 60s

# ===========================================================================
# Services
# ===========================================================================
services:
  # -------------------------------------------------------------------------
  # Relay 1 - Genesis/Bootstrap Node
  # -------------------------------------------------------------------------
  # Dieser Node startet zuerst und dient als Bootstrap fÃ¼r alle anderen.
  # Er generiert seine PeerId beim ersten Start.
  relay1:
    build: *common-build
    container_name: erynoa-relay1
    hostname: relay1
    networks:
      testnet:
        ipv4_address: 172.28.0.10
    ports:
      - "4001:4001" # P2P Swarm
      - "9001:9000" # HTTP API
    environment:
      <<: *common-env
      NODE_NAME: relay1
      NODE_MODE: relay
      P2P_PORT: "4001"
      API_PORT: "9000"
      # relay1 ist Bootstrap - keine Bootstrap-Peers nÃ¶tig
      BOOTSTRAP_PEERS: ""
      # Genesis-Node Flag
      GENESIS_NODE: "true"
      # mDNS fÃ¼r lokale Discovery
      P2P_ENABLE_MDNS: "true"
    volumes:
      - *common-volumes
      # Shared cargo caches fÃ¼r schnelle Rebuilds
      - testnet-cargo-registry:/usr/local/cargo/registry
      - testnet-cargo-git:/usr/local/cargo/git
      # Node-spezifische Build-Artifacts
      - relay1-target:/workspace/backend/target
      # Persistenter Storage
      - relay1-data:/data

  # -------------------------------------------------------------------------
  # Relay 2
  # -------------------------------------------------------------------------
  relay2:
    build: *common-build
    container_name: erynoa-relay2
    hostname: relay2
    depends_on:
      relay1:
        condition: service_started
    networks:
      testnet:
        ipv4_address: 172.28.0.11
    ports:
      - "4002:4001"
      - "9002:9000"
    environment:
      <<: *common-env
      NODE_NAME: relay2
      NODE_MODE: relay
      P2P_PORT: "4001"
      API_PORT: "9000"
      # Bootstrap via relay1 (IP-Adresse im Docker-Netzwerk)
      BOOTSTRAP_PEERS: "/ip4/172.28.0.10/tcp/4001"
      P2P_ENABLE_MDNS: "true"
    volumes:
      - *common-volumes
      - testnet-cargo-registry:/usr/local/cargo/registry
      - testnet-cargo-git:/usr/local/cargo/git
      - relay2-target:/workspace/backend/target
      - relay2-data:/data

  # -------------------------------------------------------------------------
  # Relay 3
  # -------------------------------------------------------------------------
  relay3:
    build: *common-build
    container_name: erynoa-relay3
    hostname: relay3
    depends_on:
      relay1:
        condition: service_started
    networks:
      testnet:
        ipv4_address: 172.28.0.12
    ports:
      - "4003:4001"
      - "9003:9000"
    environment:
      <<: *common-env
      NODE_NAME: relay3
      NODE_MODE: relay
      P2P_PORT: "4001"
      API_PORT: "9000"
      BOOTSTRAP_PEERS: "/ip4/172.28.0.10/tcp/4001"
      P2P_ENABLE_MDNS: "true"
    volumes:
      - *common-volumes
      - testnet-cargo-registry:/usr/local/cargo/registry
      - testnet-cargo-git:/usr/local/cargo/git
      - relay3-target:/workspace/backend/target
      - relay3-data:/data

  # -------------------------------------------------------------------------
  # Client Node
  # -------------------------------------------------------------------------
  # Client-Node fÃ¼r Tests - verbindet sich mit allen Relays
  client:
    build: *common-build
    container_name: erynoa-client
    hostname: client
    depends_on:
      relay1:
        condition: service_started
      relay2:
        condition: service_started
      relay3:
        condition: service_started
    networks:
      testnet:
        ipv4_address: 172.28.0.20
    ports:
      - "4004:4001"
      - "9004:9000"
    environment:
      <<: *common-env
      NODE_NAME: client
      NODE_MODE: client
      P2P_PORT: "4001"
      API_PORT: "9000"
      # Bootstrap Ã¼ber alle Relays fÃ¼r Redundanz
      BOOTSTRAP_PEERS: "/ip4/172.28.0.10/tcp/4001,/ip4/172.28.0.11/tcp/4001,/ip4/172.28.0.12/tcp/4001"
      P2P_ENABLE_MDNS: "true"
    volumes:
      - *common-volumes
      - testnet-cargo-registry:/usr/local/cargo/registry
      - testnet-cargo-git:/usr/local/cargo/git
      - client-target:/workspace/backend/target
      - client-data:/data

# ===========================================================================
# Networks
# ===========================================================================
networks:
  testnet:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.28.0.0/16
          gateway: 172.28.0.1

# ===========================================================================
# Volumes
# ===========================================================================
volumes:
  # Shared cargo caches (einmal fÃ¼r alle Nodes)
  testnet-cargo-registry:
  testnet-cargo-git:

  # Node-spezifische Build-Artifacts
  relay1-target:
  relay2-target:
  relay3-target:
  client-target:

  # Node-spezifische persistente Daten
  relay1-data:
  relay2-data:
  relay3-data:
  client-data:
