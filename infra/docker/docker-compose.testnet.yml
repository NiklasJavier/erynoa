# ============================================================================
# Erynoa P2P Testnet - Multi-Node Docker Compose
# ============================================================================
#
# Verwendung:
#   just testnet run     # Starten
#   just testnet down    # Stoppen
#   just testnet status  # Status
#   just testnet logs    # Logs
#
# ============================================================================

name: erynoa-testnet

services:
  relay1:
    build:
      context: ../..
      dockerfile: infra/docker/Dockerfile.testnet
    container_name: erynoa-relay1
    hostname: relay1
    networks:
      testnet:
        ipv4_address: 172.28.0.10
    ports:
      - "4001:4001"
      - "9101:9000"
    environment:
      RUST_LOG: "erynoa=info,libp2p_gossipsub=info,libp2p_kad=info,libp2p_mdns=info,info"
      RUST_BACKTRACE: "1"
      APP_STORAGE__DATA_DIR: "/data"
      NODE_NAME: relay1
      NODE_MODE: relay
      P2P_PORT: "4001"
      API_PORT: "9000"
      BOOTSTRAP_PEERS: ""
      GENESIS_NODE: "true"
      P2P_ENABLE_MDNS: "true"
    volumes:
      - relay1-data:/data
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:9000/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

  relay2:
    build:
      context: ../..
      dockerfile: infra/docker/Dockerfile.testnet
    container_name: erynoa-relay2
    hostname: relay2
    depends_on:
      relay1:
        condition: service_started
    networks:
      testnet:
        ipv4_address: 172.28.0.11
    ports:
      - "4002:4001"
      - "9102:9000"
    environment:
      RUST_LOG: "erynoa=info,libp2p_gossipsub=info,libp2p_kad=info,libp2p_mdns=info,info"
      RUST_BACKTRACE: "1"
      APP_STORAGE__DATA_DIR: "/data"
      NODE_NAME: relay2
      NODE_MODE: relay
      P2P_PORT: "4001"
      API_PORT: "9000"
      BOOTSTRAP_PEERS: "/ip4/172.28.0.10/tcp/4001"
      P2P_ENABLE_MDNS: "true"
    volumes:
      - relay2-data:/data
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:9000/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

  relay3:
    build:
      context: ../..
      dockerfile: infra/docker/Dockerfile.testnet
    container_name: erynoa-relay3
    hostname: relay3
    depends_on:
      relay1:
        condition: service_started
    networks:
      testnet:
        ipv4_address: 172.28.0.12
    ports:
      - "4003:4001"
      - "9103:9000"
    environment:
      RUST_LOG: "erynoa=info,libp2p_gossipsub=info,libp2p_kad=info,libp2p_mdns=info,info"
      RUST_BACKTRACE: "1"
      APP_STORAGE__DATA_DIR: "/data"
      NODE_NAME: relay3
      NODE_MODE: relay
      P2P_PORT: "4001"
      API_PORT: "9000"
      BOOTSTRAP_PEERS: "/ip4/172.28.0.10/tcp/4001"
      P2P_ENABLE_MDNS: "true"
    volumes:
      - relay3-data:/data
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:9000/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

  client:
    build:
      context: ../..
      dockerfile: infra/docker/Dockerfile.testnet
    container_name: erynoa-client
    hostname: client
    depends_on:
      relay1:
        condition: service_started
      relay2:
        condition: service_started
      relay3:
        condition: service_started
    networks:
      testnet:
        ipv4_address: 172.28.0.20
    ports:
      - "4004:4001"
      - "9104:9000"
    environment:
      RUST_LOG: "erynoa=info,libp2p_gossipsub=info,libp2p_kad=info,libp2p_mdns=info,info"
      RUST_BACKTRACE: "1"
      APP_STORAGE__DATA_DIR: "/data"
      NODE_NAME: client
      NODE_MODE: client
      P2P_PORT: "4001"
      API_PORT: "9000"
      BOOTSTRAP_PEERS: "/ip4/172.28.0.10/tcp/4001,/ip4/172.28.0.11/tcp/4001,/ip4/172.28.0.12/tcp/4001"
      P2P_ENABLE_MDNS: "true"
    volumes:
      - client-data:/data
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:9000/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

networks:
  testnet:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.28.0.0/16

volumes:
  relay1-data:
  relay2-data:
  relay3-data:
  client-data:
