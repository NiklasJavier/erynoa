# ============================================================================
# Erynoa P2P Testnet - Multi-Node Docker Compose
# ============================================================================
#
# Verwendung:
#   just testnet run     # Starten
#   just testnet down    # Stoppen
#   just testnet status  # Status
#   just testnet logs    # Logs
#
# ============================================================================

name: erynoa-testnet

services:
  relay1:
    build:
      context: ../..
      dockerfile: infra/docker/Dockerfile.testnet
    container_name: erynoa-relay1
    hostname: relay1
    networks:
      testnet:
        ipv4_address: 172.28.0.10
    ports:
      - "4001:4001"
      - "9001:9000"
    environment:
      RUST_LOG: "erynoa_api=debug,libp2p=info,info"
      RUST_BACKTRACE: "1"
      APP_STORAGE__DATA_DIR: "/data"
      NODE_NAME: relay1
      NODE_MODE: relay
      P2P_PORT: "4001"
      API_PORT: "9000"
      BOOTSTRAP_PEERS: ""
      GENESIS_NODE: "true"
      P2P_ENABLE_MDNS: "true"
    volumes:
      - ../../backend/src:/workspace/backend/src:cached
      - ../../backend/Cargo.toml:/workspace/backend/Cargo.toml:cached
      - ../../backend/Cargo.lock:/workspace/backend/Cargo.lock:cached
      - ../../backend/config:/workspace/backend/config:cached
      - ../../backend/build.rs:/workspace/backend/build.rs:cached
      - ../../backend/proto:/workspace/backend/proto:cached
      - ../../buf.gen.yaml:/workspace/buf.gen.yaml:cached
      - ../../buf.yaml:/workspace/buf.yaml:cached
      - ../../backend/src/gen:/workspace/backend/src/gen:cached
      - testnet-cargo-registry:/usr/local/cargo/registry
      - testnet-cargo-git:/usr/local/cargo/git
      - relay1-target:/workspace/backend/target
      - relay1-data:/data

  relay2:
    build:
      context: ../..
      dockerfile: infra/docker/Dockerfile.testnet
    container_name: erynoa-relay2
    hostname: relay2
    depends_on:
      - relay1
    networks:
      testnet:
        ipv4_address: 172.28.0.11
    ports:
      - "4002:4001"
      - "9002:9000"
    environment:
      RUST_LOG: "erynoa_api=debug,libp2p=info,info"
      RUST_BACKTRACE: "1"
      APP_STORAGE__DATA_DIR: "/data"
      NODE_NAME: relay2
      NODE_MODE: relay
      P2P_PORT: "4001"
      API_PORT: "9000"
      BOOTSTRAP_PEERS: "/ip4/172.28.0.10/tcp/4001"
      P2P_ENABLE_MDNS: "true"
    volumes:
      - ../../backend/src:/workspace/backend/src:cached
      - ../../backend/Cargo.toml:/workspace/backend/Cargo.toml:cached
      - ../../backend/Cargo.lock:/workspace/backend/Cargo.lock:cached
      - ../../backend/config:/workspace/backend/config:cached
      - ../../backend/build.rs:/workspace/backend/build.rs:cached
      - ../../backend/proto:/workspace/backend/proto:cached
      - ../../buf.gen.yaml:/workspace/buf.gen.yaml:cached
      - ../../buf.yaml:/workspace/buf.yaml:cached
      - ../../backend/src/gen:/workspace/backend/src/gen:cached
      - testnet-cargo-registry:/usr/local/cargo/registry
      - testnet-cargo-git:/usr/local/cargo/git
      - relay2-target:/workspace/backend/target
      - relay2-data:/data

  relay3:
    build:
      context: ../..
      dockerfile: infra/docker/Dockerfile.testnet
    container_name: erynoa-relay3
    hostname: relay3
    depends_on:
      - relay1
    networks:
      testnet:
        ipv4_address: 172.28.0.12
    ports:
      - "4003:4001"
      - "9003:9000"
    environment:
      RUST_LOG: "erynoa_api=debug,libp2p=info,info"
      RUST_BACKTRACE: "1"
      APP_STORAGE__DATA_DIR: "/data"
      NODE_NAME: relay3
      NODE_MODE: relay
      P2P_PORT: "4001"
      API_PORT: "9000"
      BOOTSTRAP_PEERS: "/ip4/172.28.0.10/tcp/4001"
      P2P_ENABLE_MDNS: "true"
    volumes:
      - ../../backend/src:/workspace/backend/src:cached
      - ../../backend/Cargo.toml:/workspace/backend/Cargo.toml:cached
      - ../../backend/Cargo.lock:/workspace/backend/Cargo.lock:cached
      - ../../backend/config:/workspace/backend/config:cached
      - ../../backend/build.rs:/workspace/backend/build.rs:cached
      - ../../backend/proto:/workspace/backend/proto:cached
      - ../../buf.gen.yaml:/workspace/buf.gen.yaml:cached
      - ../../buf.yaml:/workspace/buf.yaml:cached
      - ../../backend/src/gen:/workspace/backend/src/gen:cached
      - testnet-cargo-registry:/usr/local/cargo/registry
      - testnet-cargo-git:/usr/local/cargo/git
      - relay3-target:/workspace/backend/target
      - relay3-data:/data

  client:
    build:
      context: ../..
      dockerfile: infra/docker/Dockerfile.testnet
    container_name: erynoa-client
    hostname: client
    depends_on:
      - relay1
      - relay2
      - relay3
    networks:
      testnet:
        ipv4_address: 172.28.0.20
    ports:
      - "4004:4001"
      - "9004:9000"
    environment:
      RUST_LOG: "erynoa_api=debug,libp2p=info,info"
      RUST_BACKTRACE: "1"
      APP_STORAGE__DATA_DIR: "/data"
      NODE_NAME: client
      NODE_MODE: client
      P2P_PORT: "4001"
      API_PORT: "9000"
      BOOTSTRAP_PEERS: "/ip4/172.28.0.10/tcp/4001,/ip4/172.28.0.11/tcp/4001,/ip4/172.28.0.12/tcp/4001"
      P2P_ENABLE_MDNS: "true"
    volumes:
      - ../../backend/src:/workspace/backend/src:cached
      - ../../backend/Cargo.toml:/workspace/backend/Cargo.toml:cached
      - ../../backend/Cargo.lock:/workspace/backend/Cargo.lock:cached
      - ../../backend/config:/workspace/backend/config:cached
      - ../../backend/build.rs:/workspace/backend/build.rs:cached
      - ../../backend/proto:/workspace/backend/proto:cached
      - ../../buf.gen.yaml:/workspace/buf.gen.yaml:cached
      - ../../buf.yaml:/workspace/buf.yaml:cached
      - ../../backend/src/gen:/workspace/backend/src/gen:cached
      - testnet-cargo-registry:/usr/local/cargo/registry
      - testnet-cargo-git:/usr/local/cargo/git
      - client-target:/workspace/backend/target
      - client-data:/data

networks:
  testnet:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.28.0.0/16
          gateway: 172.28.0.1

volumes:
  testnet-cargo-registry:
  testnet-cargo-git:
  relay1-target:
  relay2-target:
  relay3-target:
  client-target:
  relay1-data:
  relay2-data:
  relay3-data:
  client-data:
