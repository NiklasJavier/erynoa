# ============================================================================
# Erynoa Infrastructure - Docker Compose Definition
# ============================================================================
#
# Nach ECLVM-Migration: Vereinfacht - kein DB, Cache, Storage, Auth
# Backend nutzt lokales Ed25519/DID-basiertes Storage (ECLVM)
#
# Verwendung:
#   docker compose -f infra/docker/docker-compose.yml up -d
#
# Services:
#   - backend:  Rust API mit Connect-RPC (Port 3000)
#   - console:  SvelteKit Console Frontend (Port 5173)
#   - platform: SvelteKit Platform Frontend (Port 5174)
#   - docs:     SvelteKit Docs Frontend (Port 5175)
#   - proxy:    Caddy Reverse Proxy (Port 3001)
#
# ============================================================================

name: erynoa-services

services:
  # ---------------------------------------------------------------------------
  # Console - SvelteKit + Vite mit Hot-Reloading
  # ---------------------------------------------------------------------------
  console:
    build:
      context: ../..
      dockerfile: infra/docker/Dockerfile.console
    ports:
      - "5173:5173"
    volumes:
      - ../../frontend/console/src:/workspace/frontend/console/src:cached
      - ../../frontend/console/static:/workspace/frontend/console/static:cached
      - ../../frontend/console/svelte.config.js:/workspace/frontend/console/svelte.config.js:cached
      - ../../frontend/console/vite.config.ts:/workspace/frontend/console/vite.config.ts:cached
      - ../../frontend/console/tsconfig.json:/workspace/frontend/console/tsconfig.json:cached
      - ../../frontend/console/package.json:/workspace/frontend/console/package.json:cached
      # Auch das UI-Paket mounten (f√ºr @erynoa/ui Importe)
      - ../../frontend/ui/src:/workspace/frontend/ui/src:cached
      # node_modules bleiben im Image (keine Volumes, da pnpm Workspaces)
      - ../../backend/proto:/workspace/backend/proto:cached
      - ../../buf.gen.yaml:/workspace/buf.gen.yaml:cached
      - ../../buf.yaml:/workspace/buf.yaml:cached
      - ../../pnpm-lock.yaml:/workspace/pnpm-lock.yaml:cached
      - ../../pnpm-workspace.yaml:/workspace/pnpm-workspace.yaml:cached
    environment:
      - NODE_ENV=development
      - VITE_API_URL=http://localhost:3001
    networks:
      - devnet

  # ---------------------------------------------------------------------------
  # Platform - SvelteKit + Vite mit Hot-Reloading
  # ---------------------------------------------------------------------------
  platform:
    build:
      context: ../..
      dockerfile: infra/docker/Dockerfile.platform
    ports:
      - "5174:5174"
    volumes:
      - ../../frontend/platform/src:/workspace/platform/src:cached
      - ../../frontend/platform/static:/workspace/platform/static:cached
      - ../../frontend/platform/svelte.config.js:/workspace/platform/svelte.config.js:cached
      - ../../frontend/platform/vite.config.ts:/workspace/platform/vite.config.ts:cached
      - ../../frontend/platform/tsconfig.json:/workspace/platform/tsconfig.json:cached
      - ../../frontend/platform/package.json:/workspace/platform/package.json:cached
      # node_modules bleiben im Image (keine Volumes, da pnpm Workspaces)
      - ../../backend/proto:/workspace/backend/proto:cached
      - ../../buf.gen.yaml:/workspace/buf.gen.yaml:cached
      - ../../buf.yaml:/workspace/buf.yaml:cached
      - ../../pnpm-lock.yaml:/workspace/pnpm-lock.yaml:cached
      - ../../pnpm-workspace.yaml:/workspace/pnpm-workspace.yaml:cached
    environment:
      - NODE_ENV=development
      - VITE_API_URL=http://localhost:3001
    networks:
      - devnet

  # ---------------------------------------------------------------------------
  # Docs - SvelteKit + Vite mit Hot-Reloading
  # ---------------------------------------------------------------------------
  docs:
    build:
      context: ../..
      dockerfile: infra/docker/Dockerfile.docs
    ports:
      - "5175:5175"
    volumes:
      - ../../frontend/docs/src:/workspace/docs/src:cached
      - ../../frontend/docs/static:/workspace/docs/static:cached
      - ../../frontend/docs/svelte.config.js:/workspace/docs/svelte.config.js:cached
      - ../../frontend/docs/vite.config.ts:/workspace/docs/vite.config.ts:cached
      - ../../frontend/docs/tsconfig.json:/workspace/docs/tsconfig.json:cached
      - ../../frontend/docs/package.json:/workspace/docs/package.json:cached
      # node_modules bleiben im Image (keine Volumes, da pnpm Workspaces)
      - ../../backend/proto:/workspace/backend/proto:cached
      - ../../buf.gen.yaml:/workspace/buf.gen.yaml:cached
      - ../../buf.yaml:/workspace/buf.yaml:cached
      - ../../pnpm-lock.yaml:/workspace/pnpm-lock.yaml:cached
      - ../../pnpm-workspace.yaml:/workspace/pnpm-workspace.yaml:cached
    environment:
      - NODE_ENV=development
      - VITE_API_URL=http://localhost:3001
    networks:
      - devnet

  # ---------------------------------------------------------------------------
  # Backend - Rust + Axum mit cargo watch Hot-Reloading
  # ECLVM-basiert: Lokales Storage, Ed25519/DID Auth
  # ---------------------------------------------------------------------------
  backend:
    build:
      context: ../..
      dockerfile: infra/docker/Dockerfile.backend
    ports:
      - "3000:3000"
    volumes:
      - ../../backend/src:/workspace/backend/src:cached
      - ../../backend/Cargo.toml:/workspace/backend/Cargo.toml:cached
      - ../../backend/Cargo.lock:/workspace/backend/Cargo.lock:cached
      - ../../backend/config:/workspace/backend/config:cached
      - ../../backend/build.rs:/workspace/backend/build.rs:cached
      - backend-target:/workspace/backend/target
      - cargo-registry:/usr/local/cargo/registry
      - cargo-git:/usr/local/cargo/git
      - ../../backend/proto:/workspace/backend/proto:cached
      - ../../buf.gen.yaml:/workspace/buf.gen.yaml:cached
      - ../../buf.yaml:/workspace/buf.yaml:cached
      - ../../backend/src/gen:/workspace/backend/src/gen:cached
      # Lokales ECLVM Storage (persistiert zwischen Container-Neustarts)
      - backend-storage:/workspace/backend/.erynoa
    working_dir: /workspace/backend
    environment:
      - RUST_LOG=erynoa_api=debug,info
      - APP_ENVIRONMENT=local
      # Application Settings
      - APP_APPLICATION__HOST=0.0.0.0
      - APP_APPLICATION__PORT=3000
      - APP_APPLICATION__ENVIRONMENT=local
      - APP_APPLICATION__CONSOLE_URL=http://localhost:3001/console
      - APP_APPLICATION__PLATFORM_URL=http://localhost:3001/platform
      - APP_APPLICATION__DOCS_URL=http://localhost:3001/docs
      - APP_APPLICATION__API_URL=http://localhost:3001/api
      # ECLVM Storage Settings
      - APP_STORAGE__PATH=/workspace/backend/.erynoa
    networks:
      - devnet
    healthcheck:
      test:
        [
          "CMD",
          "curl",
          "-f",
          "-X",
          "POST",
          "-H",
          "Content-Type: application/json",
          "-d",
          "{}",
          "http://localhost:3000/api/v1/connect/erynoa.v1.HealthService/Check",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 180s

  # ---------------------------------------------------------------------------
  # Caddy Reverse Proxy - Einheitlicher Einstiegspunkt auf Port 3001
  # HTTP/3 (QUIC) aktiviert fuer bessere Performance bei Mobile Clients
  # ---------------------------------------------------------------------------
  proxy:
    image: caddy:2-alpine
    ports:
      - "3001:3001"
      - "80:80"
      - "443:443/tcp"
      - "443:443/udp"
    volumes:
      - ../../infra/proxy/Caddyfile:/etc/caddy/Caddyfile:ro
      - ../../infra/static/landing.html:/etc/caddy/landing.html:ro
      - caddy-data:/data
      - caddy-config:/config
    networks:
      - devnet
    depends_on:
      - backend
      - console
      - platform
      - docs
    restart: unless-stopped

volumes:
  # Rust Build Caches
  backend-target:
  cargo-registry:
  cargo-git:
  # ECLVM lokales Storage
  backend-storage:
  # Caddy Volumes
  caddy-data:
  caddy-config:
  # Frontend node_modules bleiben im Image (pnpm Workspace Symlinks)

networks:
  devnet:
    driver: bridge
