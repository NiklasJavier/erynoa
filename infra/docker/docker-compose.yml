# ============================================================================
# Erynoa Infrastructure - Zentrale Docker Compose Definition
# ============================================================================
#
# Profile:
#   - (default): db + cache
#   - auth:      + zitadel + zitadel-db
#
# Verwendung:
#   docker compose -f infra/docker/docker-compose.yml up -d              # Basis
#   docker compose -f infra/docker/docker-compose.yml --profile auth up -d  # Mit ZITADEL
#
# ============================================================================

name: erynoa-services

services:
  # ─────────────────────────────────────────────────────────────────────────
  # Console - SvelteKit + Vite mit Hot-Reloading
  # ─────────────────────────────────────────────────────────────────────────
  console:
    build:
      context: ..
      dockerfile: infra/docker/Dockerfile.console
    ports:
      - "5173:5173"
    volumes:
      # SvelteKit source code
      - ../frontend/console/src:/workspace/console/src:cached
      - ../frontend/console/static:/workspace/console/static:cached
      # SvelteKit config files
      - ../frontend/console/svelte.config.js:/workspace/console/svelte.config.js:cached
      - ../frontend/console/vite.config.ts:/workspace/console/vite.config.ts:cached
      - ../frontend/console/tsconfig.json:/workspace/console/tsconfig.json:cached
      # Exclude node_modules (use container's version)
      - /workspace/console/node_modules
      # Proto für Code-Generierung
      - ../proto:/workspace/proto:cached
      # Buf-Konfiguration (im Workspace-Root)
      - ../buf.gen.yaml:/workspace/buf.gen.yaml:cached
      - ../buf.yaml:/workspace/buf.yaml:cached
      # Gen-Verzeichnis für Hot-Reload
      - ../frontend/console/src/gen:/workspace/console/src/gen:cached
    environment:
      - NODE_ENV=development
      - VITE_API_URL=http://localhost:3000
    networks:
      - devnet
    depends_on:
      db:
        condition: service_healthy
      cache:
        condition: service_healthy

  # ─────────────────────────────────────────────────────────────────────────
  # Platform - SvelteKit + Vite mit Hot-Reloading
  # ─────────────────────────────────────────────────────────────────────────
  platform:
    build:
      context: ..
      dockerfile: infra/docker/Dockerfile.platform
    ports:
      - "5174:5174"
    volumes:
      # SvelteKit source code
      - ../frontend/platform/src:/workspace/platform/src:cached
      - ../frontend/platform/static:/workspace/platform/static:cached
      # SvelteKit config files
      - ../frontend/platform/svelte.config.js:/workspace/platform/svelte.config.js:cached
      - ../frontend/platform/vite.config.ts:/workspace/platform/vite.config.ts:cached
      - ../frontend/platform/tsconfig.json:/workspace/platform/tsconfig.json:cached
      # Exclude node_modules (use container's version)
      - /workspace/platform/node_modules
      # Proto für Code-Generierung
      - ../proto:/workspace/proto:cached
      # Buf-Konfiguration (im Workspace-Root)
      - ../buf.gen.yaml:/workspace/buf.gen.yaml:cached
      - ../buf.yaml:/workspace/buf.yaml:cached
      # Gen-Verzeichnis für Hot-Reload
      - ../frontend/platform/src/gen:/workspace/platform/src/gen:cached
    environment:
      - NODE_ENV=development
      - VITE_API_URL=http://localhost:3000
    networks:
      - devnet
    depends_on:
      db:
        condition: service_healthy
      cache:
        condition: service_healthy

  # ─────────────────────────────────────────────────────────────────────────
  # Docs - SvelteKit + Vite mit Hot-Reloading
  # ─────────────────────────────────────────────────────────────────────────
  docs:
    build:
      context: ..
      dockerfile: infra/docker/Dockerfile.docs
    ports:
      - "5175:5175"
    volumes:
      # SvelteKit source code
      - ../frontend/docs/src:/workspace/docs/src:cached
      - ../frontend/docs/static:/workspace/docs/static:cached
      # SvelteKit config files
      - ../frontend/docs/svelte.config.js:/workspace/docs/svelte.config.js:cached
      - ../frontend/docs/vite.config.ts:/workspace/docs/vite.config.ts:cached
      - ../frontend/docs/tsconfig.json:/workspace/docs/tsconfig.json:cached
      # Exclude node_modules (use container's version)
      - /workspace/docs/node_modules
      # Proto für Code-Generierung
      - ../proto:/workspace/proto:cached
      # Buf-Konfiguration (im Workspace-Root)
      - ../buf.gen.yaml:/workspace/buf.gen.yaml:cached
      - ../buf.yaml:/workspace/buf.yaml:cached
      # Gen-Verzeichnis für Hot-Reload
      - ../frontend/docs/src/gen:/workspace/docs/src/gen:cached
    environment:
      - NODE_ENV=development
      - VITE_API_URL=http://localhost:3000
    networks:
      - devnet
    depends_on:
      db:
        condition: service_healthy
      cache:
        condition: service_healthy

  # ─────────────────────────────────────────────────────────────────────────
  # Backend - Rust + Axum mit cargo watch Hot-Reloading
  # Optimiert für Container-in-Container (DinD) Entwicklungsumgebung
  # ─────────────────────────────────────────────────────────────────────────
  backend:
    build:
      context: ..
      dockerfile: infra/docker/Dockerfile.backend
    ports:
      - "3000:3000"
    volumes:
      # Source Code - Mounte das ganze Backend-Verzeichnis
      - ../backend/src:/workspace/backend/src:cached
      - ../backend/Cargo.toml:/workspace/backend/Cargo.toml:cached
      - ../backend/Cargo.lock:/workspace/backend/Cargo.lock:cached
      - ../backend/config:/workspace/backend/config:cached
      - ../backend/migrations:/workspace/backend/migrations:cached
      - ../backend/build.rs:/workspace/backend/build.rs:cached
      # Separate Volume für target/ - verhindert Konflikte zwischen Host und Container
      - backend-target:/workspace/backend/target
      # Cargo Registry Cache - beschleunigt Dependency Downloads
      - cargo-registry:/usr/local/cargo/registry
      - cargo-git:/usr/local/cargo/git
      # Proto für Code-Generierung (Backend + Console)
      - ../proto:/workspace/proto:cached
      # Buf-Konfiguration (für Console-Generierung)
      - ../buf.gen.yaml:/workspace/buf.gen.yaml:cached
      - ../buf.yaml:/workspace/buf.yaml:cached
      # Backend gen/ für Hot-Reload (wird von build.rs erstellt)
      - ../backend/src/gen:/workspace/backend/src/gen:cached
    working_dir: /workspace/backend
    environment:
      - RUST_LOG=erynoa_api=debug,info
      - APP_ENVIRONMENT=local
      # Application Settings
      - APP_APPLICATION__HOST=0.0.0.0
      - APP_APPLICATION__PORT=3000
      - APP_APPLICATION__ENVIRONMENT=local
      - APP_APPLICATION__CONSOLE_URL=http://localhost:3001/console
      - APP_APPLICATION__PLATFORM_URL=http://localhost:3001/platform
      - APP_APPLICATION__DOCS_URL=http://localhost:3001/docs
      - APP_APPLICATION__API_URL=http://localhost:3000
      # Database Settings (using Docker service names instead of localhost)
      - APP_DATABASE__HOST=db
      - APP_DATABASE__PORT=5432
      - APP_DATABASE__USERNAME=erynoa
      - APP_DATABASE__PASSWORD=erynoa
      - APP_DATABASE__DATABASE=erynoa
      - APP_DATABASE__MAX_CONNECTIONS=10
      - APP_DATABASE__MIN_CONNECTIONS=2
      - APP_DATABASE__CONNECT_TIMEOUT=30
      - APP_DATABASE__IDLE_TIMEOUT=300
      # Cache Settings
      - APP_CACHE__URL=redis://cache:6379
      - APP_CACHE__POOL_SIZE=10
      - APP_CACHE__DEFAULT_TTL=3600
      # Auth Settings (ZITADEL)
      - APP_AUTH__ISSUER=http://localhost:8080
      - APP_AUTH__INTERNAL_ISSUER=http://zitadel:8080
      - APP_AUTH__CLIENT_ID=erynoa-backend
      # CONSOLE_CLIENT_ID, PLATFORM_CLIENT_ID und DOCS_CLIENT_ID kommen aus backend/config/local.toml (wird vom setup-zitadel.sh gesetzt)
      - APP_AUTH__JWKS_CACHE_DURATION=3600
      - APP_AUTH__AUDIENCES=erynoa-api,erynoa-backend,erynoa-console,erynoa-platform,erynoa-docs
      # Storage Settings (MinIO S3)
      - APP_STORAGE__ENDPOINT=http://minio:9000
      - APP_STORAGE__REGION=us-east-1
      - APP_STORAGE__ACCESS_KEY_ID=erynoa
      - APP_STORAGE__SECRET_ACCESS_KEY=erynoa123
      - APP_STORAGE__DEFAULT_BUCKET=erynoa
      - APP_STORAGE__MAX_UPLOAD_SIZE=104857600
    networks:
      - devnet
    depends_on:
      db:
        condition: service_healthy
      cache:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "-X", "POST", "-H", "Content-Type: application/json", "-d", "{}", "http://localhost:3000/api/v1/connect/erynoa.v1.HealthService/Check"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 180s  # 3 Minuten für Kompilierung und Startup

  # ─────────────────────────────────────────────────────────────────────────
  # ─────────────────────────────────────────────────────────────────────────
  # PostgreSQL (App-Datenbank) - OrioleDB für bessere Performance
  # ─────────────────────────────────────────────────────────────────────────
  db:
    image: orioledb/orioledb:latest-pg16
    environment:
      POSTGRES_USER: erynoa
      POSTGRES_PASSWORD: erynoa
      POSTGRES_DB: erynoa
    volumes:
      - pgdata:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U erynoa -h localhost -p 5432"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s
    command:
      - postgres
      - -c
      - shared_preload_libraries=orioledb
      - -c
      - default_table_access_method=orioledb
      - -c
      - listen_addresses=*
    networks:
      - devnet

  # ─────────────────────────────────────────────────────────────────────────  # ⚡ PgBouncer - Connection Pooler (GOD MODE: Skalierbarkeit)
  # Apps verbinden sich zu pgbouncer:6432 statt direkt zu db:5432
  # PgBouncer hält wenige echte DB-Connections und verteilt sie effizient
  # ─────────────────────────────────────────────────────────────────────────────
  pgbouncer:
    image: bitnami/pgbouncer:latest
    profiles: [production]  # Nur in Production aktivieren
    environment:
      - POSTGRESQL_HOST=db
      - POSTGRESQL_PORT=5432
      - POSTGRESQL_USERNAME=erynoa
      - POSTGRESQL_PASSWORD=erynoa
      - POSTGRESQL_DATABASE=erynoa
      - PGBOUNCER_DATABASE=erynoa
      - PGBOUNCER_PORT=6432
      - PGBOUNCER_POOL_MODE=transaction  # Beste Balance für Web-Apps
      - PGBOUNCER_MAX_CLIENT_CONN=1000   # Max Clients
      - PGBOUNCER_DEFAULT_POOL_SIZE=20   # Echte DB-Connections pro Pool
      - PGBOUNCER_MIN_POOL_SIZE=5
      - PGBOUNCER_RESERVE_POOL_SIZE=5
    ports:
      - "6432:6432"
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "pg_isready", "-h", "localhost", "-p", "6432", "-U", "erynoa"]
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - devnet

  # ─────────────────────────────────────────────────────────────────────────────  # Dragonfly Cache (Redis-kompatibel, schneller)
  # ─────────────────────────────────────────────────────────────────────────
  cache:
    image: docker.dragonflydb.io/dragonflydb/dragonfly:latest
    ports:
      - "6379:6379"
    volumes:
      - dragonfly:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - devnet

  # ─────────────────────────────────────────────────────────────────────────
  # MinIO S3 Object Storage
  # ─────────────────────────────────────────────────────────────────────────
  minio:
    image: quay.io/minio/minio:latest
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: erynoa
      MINIO_ROOT_PASSWORD: erynoa123
    volumes:
      - minio-data:/data
    ports:
      - "9000:9000"   # S3 API
      - "9001:9001"   # Web Console
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 5s
    networks:
      - devnet

  # ─────────────────────────────────────────────────────────────────────────
  # ZITADEL PostgreSQL (separate DB für Auth)
  # ─────────────────────────────────────────────────────────────────────────
  zitadel-db:
    image: postgres:16-alpine
    profiles: [auth]
    environment:
      POSTGRES_USER: zitadel
      POSTGRES_PASSWORD: zitadel
      POSTGRES_DB: zitadel
    volumes:
      - zitadel-pgdata:/var/lib/postgresql/data
    ports:
      - "5433:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U zitadel -h localhost"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s
    networks:
      - devnet

  # ─────────────────────────────────────────────────────────────────────────
  # ZITADEL Init - Bereitet Volume-Berechtigungen vor
  # ─────────────────────────────────────────────────────────────────────────
  zitadel-init:
    image: busybox
    profiles: [auth]
    command: sh -c "mkdir -p /machinekey && chmod 777 /machinekey"
    volumes:
      - zitadel-machinekey:/machinekey
    networks:
      - devnet

  # ─────────────────────────────────────────────────────────────────────────
  # ZITADEL - Identity Provider
  # ─────────────────────────────────────────────────────────────────────────
  zitadel:
    image: ghcr.io/zitadel/zitadel:v2.64.1
    profiles: [auth]
    command: 'start-from-init --masterkeyFromEnv --tlsMode disabled --steps /zitadel-init-steps.yaml'
    environment:
      ZITADEL_MASTERKEY: "MasterkeyNeedsToHave32Characters"
      ZITADEL_DATABASE_POSTGRES_HOST: zitadel-db
      ZITADEL_DATABASE_POSTGRES_PORT: "5432"
      ZITADEL_DATABASE_POSTGRES_DATABASE: zitadel
      ZITADEL_DATABASE_POSTGRES_USER_USERNAME: zitadel
      ZITADEL_DATABASE_POSTGRES_USER_PASSWORD: zitadel
      ZITADEL_DATABASE_POSTGRES_USER_SSL_MODE: disable
      ZITADEL_DATABASE_POSTGRES_ADMIN_USERNAME: zitadel
      ZITADEL_DATABASE_POSTGRES_ADMIN_PASSWORD: zitadel
      ZITADEL_DATABASE_POSTGRES_ADMIN_SSL_MODE: disable
      ZITADEL_DATABASE_POSTGRES_ADMIN_EXISTINGDATABASE: zitadel
      ZITADEL_EXTERNALSECURE: "false"
      ZITADEL_EXTERNALPORT: "8080"
      ZITADEL_EXTERNALDOMAIN: "localhost"
      # Deaktiviere strikte Domain-Validierung für Development (erlaubt zitadel:8080 intern)
      ZITADEL_SYSTEMDEFAULTS_DOMAINVERIFICATIONREQUIRED: "false"
    depends_on:
      zitadel-db:
        condition: service_healthy
      zitadel-init:
        condition: service_completed_successfully
    ports:
      - "8080:8080"
    volumes:
      - ../auth/zitadel/init-steps.yaml:/zitadel-init-steps.yaml:ro
      - zitadel-machinekey:/machinekey
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/debug/ready"]
      interval: 10s
      timeout: 5s
      retries: 15
      start_period: 30s
    networks:
      - devnet

  # ─────────────────────────────────────────────────────────────────────────
  # Caddy Reverse Proxy - Einheitlicher Einstiegspunkt auf Port 3001
  # ⚡ HTTP/3 (QUIC) aktiviert für bessere Performance bei Mobile Clients
  # ─────────────────────────────────────────────────────────────────────────────
  proxy:
    image: caddy:2-alpine
    ports:
      - "3001:3001"        # HTTP Dev
      - "80:80"            # HTTP Legacy
      - "443:443/tcp"      # HTTPS (TCP)
      - "443:443/udp"      # ⚡ HTTP/3 (QUIC) - wichtig für Mobile Performance
    volumes:
      - ../proxy/Caddyfile:/etc/caddy/Caddyfile:ro
      - ../static/landing.html:/etc/caddy/landing.html:ro
      - caddy-data:/data   # TLS Zertifikate & HTTP/3 State
      - caddy-config:/config
    networks:
      - devnet
    depends_on:
      - backend
      - console
      - platform
      - docs
    restart: unless-stopped

volumes:
  pgdata:
  zitadel-pgdata:
  zitadel-machinekey:
  dragonfly:
  minio-data:
  # Rust Build Caches für schnellere Rebuilds in Container-in-Container
  backend-target:      # Rust target/ Verzeichnis (Build-Artefakte)
  cargo-registry:      # Cargo Registry Cache (crates.io Index)
  cargo-git:           # Git Dependencies Cache
  # ⚡ Caddy Volumes für TLS Zertifikate und HTTP/3 State
  caddy-data:
  caddy-config:

networks:
  devnet:
    driver: bridge
