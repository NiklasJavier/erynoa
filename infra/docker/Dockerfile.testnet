# ============================================================================
# Erynoa P2P Testnet Node Dockerfile
# Multi-Node Entwicklungsumgebung mit Hot-Reloading
# ============================================================================
#
# Features:
#   - P2P-Stack mit libp2p (Gossipsub, Kademlia, mDNS)
#   - Hot-Reloading via cargo-watch
#   - MOLD-Linker fÃ¼r schnelle Rebuilds
#   - Privacy-Layer Support (optional)
#
# Verwendung:
#   docker compose -f infra/docker/docker-compose.testnet.yml up
#
# ============================================================================

FROM rust:1.88-bookworm

# Build-Optimierungen
ENV CARGO_INCREMENTAL=1 \
    CARGO_NET_GIT_FETCH_WITH_CLI=true \
    RUST_BACKTRACE=1 \
    # libp2p-spezifisch: Noise Protocol Logging reduzieren
    RUST_LOG=erynoa_api=debug,libp2p_gossipsub=info,libp2p_kad=info,libp2p_mdns=debug,info

# System-AbhÃ¤ngigkeiten inkl. MOLD-Linker
RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates \
    curl \
    build-essential \
    pkg-config \
    libssl-dev \
    cmake \
    clang \
    mold \
    dnsutils \
    net-tools \
    iproute2 \
    && rm -rf /var/lib/apt/lists/*

# cargo-binstall fÃ¼r schnelle Tool-Installation
RUN curl -L --proto '=https' --tlsv1.2 -sSf \
    https://raw.githubusercontent.com/cargo-bins/cargo-binstall/main/install-from-binstall-release.sh | bash

# cargo-watch fÃ¼r Hot-Reloading
RUN cargo binstall cargo-watch -y --force

WORKDIR /workspace

# Copy workspace root files needed for build
COPY buf.yaml ./buf.yaml
COPY buf.gen.yaml ./buf.gen.yaml

WORKDIR /workspace/backend

# Kopiere Proto-Dateien
COPY backend/proto ./proto

# Kopiere Cargo-Files und build.rs fÃ¼r Dependency-Caching
COPY backend/Cargo.toml ./Cargo.toml
COPY backend/Cargo.lock ./Cargo.lock
COPY backend/build.rs ./build.rs

# Kopiere src/gen fÃ¼r generierte Proto-Files
COPY backend/src/gen ./src/gen

# Pre-fetch dependencies mit P2P-Feature
# Erstellt einen Dummy-Build um Dependencies zu cachen
RUN mkdir -p src/bin && \
    echo "fn main() {}" > src/main.rs && \
    echo "fn main() {}" > src/bin/testnet_node.rs && \
    echo "// lib" > src/lib.rs && \
    RUSTFLAGS="-C link-arg=-fuse-ld=mold" cargo fetch && \
    rm -rf src/main.rs src/bin/testnet_node.rs src/lib.rs

# Kopiere den Rest des Source-Codes
COPY backend/src ./src
COPY backend/config ./config

WORKDIR /workspace/backend

# P2P Ports:
#   4001 - libp2p Swarm (TCP/QUIC)
#   9000 - HTTP API
EXPOSE 4001 9000

# Build the testnet binary - this caches the compilation
RUN RUSTFLAGS="-C link-arg=-fuse-ld=mold" cargo build --release --features p2p --bin erynoa-testnet-node

# ============================================================================
# Development Entrypoint (Hot-Reloading mit cargo-watch)
# ============================================================================
RUN cat > /entrypoint-dev.sh << 'DEVEOF'
#!/bin/bash
set -e

# Bestimme welche Features zu aktivieren sind
FEATURES="${CARGO_FEATURES:-p2p}"

echo "========================================="
echo "ðŸ”¥ Erynoa P2P Testnet Node - DEV MODE"
echo "========================================="
echo "  Node:      ${NODE_NAME:-relay}"
echo "  P2P Port:  ${P2P_PORT:-4001}"
echo "  API Port:  ${API_PORT:-9000}"
echo "  Bootstrap: ${BOOTSTRAP_PEERS:-none}"
echo "  Mode:      ${NODE_MODE:-relay}"
echo "  Features:  ${FEATURES}"
echo "========================================="
echo ""
echo "ðŸ”„ Hot-Reloading aktiviert!"
echo "   Ã„nderungen an src/ werden automatisch erkannt."
echo ""

# Warte auf Bootstrap-Peers
if [ -n "$BOOTSTRAP_PEERS" ]; then
    echo "Waiting for bootstrap peers..."
    for peer in $(echo $BOOTSTRAP_PEERS | tr ',' ' '); do
        host=$(echo $peer | sed 's|/ip4/\([^/]*\)/.*|\1|')
        if [[ ! $host =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "  Resolving $host..."
            until getent hosts $host > /dev/null 2>&1; do
                sleep 1
            done
            echo "  âœ“ $host resolved"
        fi
    done
fi

# Staggered start fÃ¼r verschiedene Nodes
case $NODE_NAME in
    relay1) DELAY=0 ;;
    relay2) DELAY=5 ;;
    relay3) DELAY=10 ;;
    client) DELAY=15 ;;
    *) DELAY=0 ;;
esac

if [ $DELAY -gt 0 ]; then
    echo "â³ Warte ${DELAY}s fÃ¼r gestaffelten Start..."
    sleep $DELAY
fi

echo ""
echo "ðŸš€ Starte mit cargo-watch..."
echo "   Features: ${FEATURES}"
echo "   Bei Ã„nderungen wird automatisch neu kompiliert."
echo ""

# cargo-watch: Beobachtet src/ und startet bei Ã„nderungen neu
exec cargo watch \
    --watch src \
    --watch Cargo.toml \
    -x "build --features ${FEATURES} --bin erynoa-testnet-node" \
    -s "RUST_LOG=${RUST_LOG:-info} ./target/debug/erynoa-testnet-node"
DEVEOF

RUN chmod +x /entrypoint-dev.sh

# ============================================================================
# Production Entrypoint
# ============================================================================
# Entrypoint-Script fÃ¼r P2P-Node
RUN cat > /entrypoint.sh << 'EOF'
#!/bin/bash
set -e

echo "========================================="
echo "ðŸŒ Erynoa P2P Testnet Node"
echo "========================================="
echo "  Node:      ${NODE_NAME:-relay}"
echo "  P2P Port:  ${P2P_PORT:-4001}"
echo "  API Port:  ${API_PORT:-9000}"
echo "  Bootstrap: ${BOOTSTRAP_PEERS:-none}"
echo "  Mode:      ${NODE_MODE:-relay}"
echo "========================================="

# Warte auf DNS-AuflÃ¶sung der Bootstrap-Peers
if [ -n "$BOOTSTRAP_PEERS" ]; then
    echo "Waiting for bootstrap peers..."
    for peer in $(echo $BOOTSTRAP_PEERS | tr ',' ' '); do
        host=$(echo $peer | sed 's|/ip4/\([^/]*\)/.*|\1|')
        # DNS-Namen auflÃ¶sen wenn nÃ¶tig
        if [[ ! $host =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "  Resolving $host..."
            until getent hosts $host > /dev/null 2>&1; do
                sleep 1
            done
            echo "  âœ“ $host resolved"
        fi
    done
fi

echo ""
echo "Starting testnet node..."
echo ""

# Run the pre-built binary
exec /workspace/backend/target/release/erynoa-testnet-node
EOF

RUN chmod +x /entrypoint.sh

ENTRYPOINT ["/entrypoint.sh"]
