# Console Dockerfile mit Vite Hot-Reloading (SvelteKit)
FROM node:20-alpine

WORKDIR /workspace

# Installiere buf fÃ¼r Proto-Code-Generierung
RUN apk add --no-cache curl unzip && \
    BUF_VERSION=1.36.0 && \
    curl -sSL "https://github.com/bufbuild/buf/releases/download/v${BUF_VERSION}/buf-Linux-x86_64" \
    -o "/usr/local/bin/buf" && \
    chmod +x /usr/local/bin/buf && \
    apk del curl unzip

WORKDIR /workspace/console

# Installiere npm AbhÃ¤ngigkeiten
COPY frontend/console/package*.json ./
RUN npm ci

# Kopiere Console Code
COPY frontend/console .

# Exponiere Port fÃ¼r Vite Dev Server
EXPOSE 5173

# Erstelle Proto-Watch Script (Node.js-basiert fÃ¼r Alpine)
RUN cat > /workspace/proto-watch.js << 'EOF'
const { watch } = require('fs');
const { spawn } = require('child_process');

console.log('ðŸ”„ Watching backend/proto/ directory for changes...');

watch('/workspace/backend/proto', { recursive: true }, (eventType, filename) => {
  if (filename && filename.endsWith('.proto')) {
    console.log(`ðŸ”„ Proto file changed: ${filename}, regenerating...`);
    const buf = spawn('buf', ['generate'], {
      cwd: '/workspace',
      stdio: 'pipe',
      shell: true,
      env: { ...process.env }
    });
    let stderr = '';
    buf.stderr.on('data', (data) => { stderr += data.toString(); });
    buf.on('close', (code) => {
      if (code === 0) {
        console.log('âœ… Proto code regenerated');
      } else {
        // Rate limit errors are non-critical
        if (stderr.includes('too many requests') || stderr.includes('rate limit')) {
          console.log('âš ï¸  Proto generation rate limited (will retry later)');
        } else {
          console.log('âš ï¸  Proto generation failed (code: ' + code + ')');
        }
      }
    });
    buf.on('error', (err) => {
      console.log('âš ï¸  Proto generation error:', err.message);
    });
  }
});
EOF

# Erstelle Entrypoint-Script fÃ¼r Proto-Watching + Vite
RUN cat > /entrypoint.sh << 'EOF'
#!/bin/sh
# Don't exit on error - we want to continue even if proto generation fails
set +e

echo "========================================="
echo "Console Container Starting (SvelteKit)..."
echo "========================================="

# Generiere Proto-Code beim Start
echo "[1/3] Generating Proto code..."
cd /workspace
if [ -f "buf.gen.yaml" ]; then
  buf_output=$(buf generate 2>&1)
  buf_exit=$?
  if [ $buf_exit -eq 0 ]; then
    echo "âœ… Proto code generated"
  else
    # Check for rate limit errors (non-critical)
    if echo "$buf_output" | grep -qiE "too many requests|rate limit"; then
      echo "âš ï¸  Proto generation rate limited (will retry on file changes)"
    else
      echo "âš ï¸  Proto generation failed (will retry on file changes)"
    fi
  fi
else
  echo "âš ï¸  buf.gen.yaml not found, skipping proto generation"
fi

# Starte Proto-Watcher im Hintergrund
echo "[2/3] Starting Proto file watcher..."
node /workspace/proto-watch.js &
WATCHER_PID=$!

# SvelteKit Sync (generiert .svelte-kit Verzeichnis)
echo "[3/3] Running SvelteKit sync..."
cd /workspace/console
npx svelte-kit sync 2>/dev/null || true

# Starte Vite Dev Server
echo "========================================="
echo "Starting Vite Dev Server (SvelteKit)..."
echo "Proto changes will trigger regeneration"
echo "========================================="

exec npm run dev -- --host 0.0.0.0 --port 5173
EOF

RUN chmod +x /entrypoint.sh

ENTRYPOINT ["/entrypoint.sh"]
