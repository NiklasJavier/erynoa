{
  "name": "Godstack Monorepo",
  "dockerComposeFile": "docker-compose.yml",
  "service": "dev",
  "workspaceFolder": "/workspace",

  "features": {
    // Docker-in-Docker für die Services (DB, Zitadel, etc.)
    "ghcr.io/devcontainers/features/docker-in-docker:2": {},
    
    // Die offizielle Nix-Integration (ersetzt deine manuellen Skripte)
    "ghcr.io/devcontainers/features/nix:1": {
      "version": "latest",
      "multiUser": true,
      "flakeUri": "" // Wir nutzen direnv, daher hier leer lassen
    },
    
    // Installiert direnv und nützliche Tools auf Systemebene
    "ghcr.io/devcontainers/features/common-utils:2": {
      "configureZshAsDefaultShell": true,
      "installDirenv": true
    }
  },

  "mounts": [
    "source=${localEnv:HOME}/.ssh,target=/home/vscode/.ssh-host,type=bind,readonly",
    // SSH-Agent Socket vom macOS Host durchleiten
    "source=${localEnv:SSH_AUTH_SOCK},target=/ssh-agent,type=bind"
  ],

  // SSH-Agent Environment Variable im Container setzen
  "remoteEnv": {
    "SSH_AUTH_SOCK": "/ssh-agent"
  },

  "customizations": {
    "vscode": {
      "extensions": [
        "rust-lang.rust-analyzer",
        "tamasfe.even-better-toml",
        "serayuzgur.crates",
        "vadimcn.vscode-lldb",
        "fill-labs.dependi",
        "usernamehw.errorlens",
        "eamodio.gitlens",
        "mkhl.direnv",
        "jnoortheen.nix-ide" // Empfohlen für Nix-Syntax
      ],
      "settings": {
        "rust-analyzer.check.command": "clippy",
        "nix.enableLanguageServer": true,
        "nix.serverPath": "nil", // oder "nixd", sollte via flake kommen
        "direnv.restart.automatic": true
      }
    }
  },

  // Ports für Development
  "forwardPorts": [3000, 5173, 5432, 5433, 6379, 8080, 9000, 9001],
  "portsAttributes": {
    "3000": { "label": "Backend API", "onAutoForward": "notify" },
    "5173": { "label": "Frontend (Vite)", "onAutoForward": "openBrowserOnce" },
    "5432": { "label": "PostgreSQL (App)", "onAutoForward": "ignore" },
    "5433": { "label": "PostgreSQL (ZITADEL)", "onAutoForward": "ignore" },
    "6379": { "label": "Redis/Dragonfly", "onAutoForward": "ignore" },
    "8080": { "label": "ZITADEL Auth", "onAutoForward": "notify" },
    "9000": { "label": "MinIO S3", "onAutoForward": "ignore" },
    "9001": { "label": "MinIO Console", "onAutoForward": "notify" }
  },

  "postCreateCommand": ".devcontainer/setup.sh",
  "postStartCommand": ".devcontainer/init.sh",
  // Wir verlassen uns auf direnv, keine manuellen nix develop commands im attach nötig
  // direnv hook wird durch das common-utils Feature gesetzt
  
  "remoteUser": "vscode"
}