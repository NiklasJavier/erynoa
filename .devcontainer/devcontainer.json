{
	"name": "Erynoa Monorepo",
	"dockerComposeFile": "docker-compose.yml",
	"service": "dev",
	"workspaceFolder": "/workspace",

	"features": {
		// Docker-in-Docker für die Services (DB, Zitadel, etc.)
		"ghcr.io/devcontainers/features/docker-in-docker:2": {},

		// Die offizielle Nix-Integration (ersetzt deine manuellen Skripte)
		"ghcr.io/devcontainers/features/nix:1": {
			"version": "latest",
			"multiUser": true,
			"flakeUri": "", // Wir nutzen direnv, daher hier leer lassen
			// ⚡ WICHTIG: Binary Caches aktivieren (verhindert lokales Kompilieren von rustc etc.)
			// Hinweis: trusted-public-keys, keep-outputs, keep-derivations sind restricted settings
			// und werden systemweit durch das Nix Feature gesetzt
			"extraNixConfig": "substituters = https://cache.nixos.org\nmax-jobs = auto"
		},

		// Installiert direnv und nützliche Tools auf Systemebene
		"ghcr.io/devcontainers/features/common-utils:2": {
			"configureZshAsDefaultShell": true,
			"installDirenv": true
		}
	},

	"mounts": [
		"source=${localEnv:HOME}/.ssh,target=/home/vscode/.ssh-host,type=bind,readonly",
		// SSH-Agent Socket vom macOS Host durchleiten
		"source=${localEnv:SSH_AUTH_SOCK},target=/ssh-agent,type=bind",
		// Git-Config vom Host übernehmen (optional, falls vorhanden)
		"source=${localEnv:HOME}/.gitconfig,target=/home/vscode/.gitconfig-host,type=bind,readonly",
		// GPG-Keys vom Host übernehmen (optional, falls vorhanden)
		"source=${localEnv:HOME}/.gnupg,target=/home/vscode/.gnupg-host,type=bind,readonly",

		// ⚡ CACHING: Cargo Registry persistent machen (verhindert Re-Download bei Rebuild)
		"source=cargo-cache,target=/usr/local/cargo,type=volume",
		// ⚡ CACHING: pnpm Store persistent machen
		"source=pnpm-store,target=/home/vscode/.local/share/pnpm,type=volume"
	],

	// SSH-Agent Environment Variable im Container setzen
	"remoteEnv": {
		"SSH_AUTH_SOCK": "/ssh-agent",
		"WORKSPACE_ROOT": "/workspace"
		// Git-Konfiguration wird automatisch von .gitconfig-host übernommen
		// Optional: Setze GIT_USER_NAME und GIT_USER_EMAIL auf dem Host als Environment-Variablen
	},

	"customizations": {
		"vscode": {
			"extensions": [
				// Rust Development
				"rust-lang.rust-analyzer",
				"tamasfe.even-better-toml",
				"serayuzgur.crates",
				"vadimcn.vscode-lldb",

				// Frontend Development
				"svelte.svelte-vscode",
				"bradlc.vscode-tailwindcss", // Tailwind CSS IntelliSense
				"dbaeumer.vscode-eslint",
				"biomejs.biome",

				// Protobuf / Connect-RPC
				"bufbuild.buf", // Buf Protobuf Support
				"zxh404.vscode-proto3", // Proto3 Syntax Highlighting

				// Database & Cache
				"ms-ossdata.vscode-postgresql", // PostgreSQL Extension (Microsoft)
				"Redis.redis-for-vscode", // Redis/Dragonfly Extension

				// Docker & Infrastructure
				"ms-azuretools.vscode-docker", // Docker Support

				// YAML (Docker Compose, GitHub Actions)
				"redhat.vscode-yaml", // YAML Support mit Schema-Validierung

				// Shell Scripts
				"timonwong.shellcheck", // Shell Script Linting
				"mads-hartmann.bash-ide-vscode", // Bash IDE

				// Markdown (Dokumentation)
				"yzhang.markdown-all-in-one", // Markdown Preview & Editing
				"davidanson.vscode-markdownlint", // Markdown Linting

				// Development Tools
				"fill-labs.dependi", // Dependency Insights
				"usernamehw.errorlens", // Inline Error Annotations
				"eamodio.gitlens", // Git Supercharged
				"mkhl.direnv", // direnv Support
				"jnoortheen.nix-ide" // Nix Language Support
			],
			"settings": {
				// Rust
				"rust-analyzer.check.command": "clippy",
				"rust-analyzer.inlayHints.typeHints.enable": true,
				"rust-analyzer.inlayHints.parameterHints.enable": true,
				"rust-analyzer.inlayHints.chainingHints.enable": true,

				// Nix
				"nix.enableLanguageServer": true,
				"nix.serverPath": "nil", // oder "nixd", sollte via flake kommen

				// direnv
				"direnv.restart.automatic": true,

				// Svelte
				"svelte.enable-ts-plugin": true,
				"svelte.plugin.svelte.compilerWarnings": {
					"a11y-no-static-element-interactions": "ignore",
					"a11y-no-noninteractive-element-interactions": "ignore"
				},

				// Tailwind CSS
				"tailwindCSS.experimental.classRegex": [
					["cva\\(([^)]*)\\)", "[\"'`]([^\"'`]*).*?[\"'`]"],
					["cn\\(([^)]*)\\)", "(?:'|\"|`)([^\"'`]*)(?:'|\"|`)"]
				],
				"tailwindCSS.includeLanguages": {
					"svelte": "html"
				},

				// TypeScript/JavaScript
				"typescript.updateImportsOnFileMove.enabled": "always",
				"typescript.preferences.importModuleSpecifier": "relative",
				"javascript.updateImportsOnFileMove.enabled": "always",

				// Biome (als Formatter)
				"[javascript]": {
					"editor.defaultFormatter": "biomejs.biome",
					"editor.formatOnSave": true
				},
				"[typescript]": {
					"editor.defaultFormatter": "biomejs.biome",
					"editor.formatOnSave": true
				},
				"[json]": {
					"editor.defaultFormatter": "biomejs.biome",
					"editor.formatOnSave": true
				},
				"[jsonc]": {
					"editor.defaultFormatter": "biomejs.biome",
					"editor.formatOnSave": true
				},
				"[svelte]": {
					"editor.defaultFormatter": "svelte.svelte-vscode",
					"editor.formatOnSave": true
				},

				// ESLint (für Svelte)
				"eslint.validate": [
					"javascript",
					"javascriptreact",
					"typescript",
					"typescriptreact",
					"svelte"
				],

				// YAML
				"yaml.schemas": {
					"https://json.schemastore.org/github-workflow.json": "/.github/workflows/*.yml",
					"https://raw.githubusercontent.com/compose-spec/compose-spec/master/schema/compose-spec.json": "docker-compose*.yml"
				},
				"yaml.format.enable": true,
				"yaml.validate": true,

				// Shell Scripts
				"shellcheck.enable": true,
				"shellcheck.run": "onSave",
				"bash-ide-vscode.enableSourceErrorDiagnostics": true,

				// Markdown
				"markdown.preview.breaks": true,
				"markdown.preview.fontSize": 14,
				"markdownlint.config": {
					"default": true,
					"MD013": false, // Zeilenlänge
					"MD033": false, // HTML erlauben
					"MD041": false // Erste Zeile muss Heading sein
				},

				// Protobuf
				"protoc": {
					"options": ["--proto_path=${workspaceFolder}/backend/proto"]
				},

				// PostgreSQL Connections
				"postgresql.connections": [
					{
						"host": "localhost",
						"port": 5432,
						"database": "erynoa",
						"username": "erynoa",
						"password": "erynoa",
						"label": "Erynoa App Database (OrioleDB)"
					},
					{
						"host": "localhost",
						"port": 5433,
						"database": "zitadel",
						"username": "zitadel",
						"password": "zitadel",
						"label": "ZITADEL Database"
					}
				],

				// Redis/Dragonfly Connection
				"redis.connections": [
					{
						"host": "localhost",
						"port": 6379,
						"label": "Dragonfly Cache"
					}
				],

				// Docker
				"docker.showStartPage": false,
				"docker.defaultRegistryPath": "",

				// Editor
				"editor.formatOnSave": true,
				"editor.codeActionsOnSave": {
					"source.fixAll": "explicit",
					"source.organizeImports": "explicit"
				},
				"files.trimTrailingWhitespace": true,
				"files.insertFinalNewline": true,
				"files.trimFinalNewlines": true,

				// File Associations
				"files.associations": {
					"*.proto": "proto3",
					"justfile": "just",
					"Justfile": "just"
				}
			}
		}
	},

	// Ports für Development
	"forwardPorts": [3000, 3001, 5173, 5174, 5175, 5432, 5433, 6379, 8080, 9000, 9001],
	"portsAttributes": {
		"3000": { "label": "Backend API", "onAutoForward": "notify" },
		"3001": { "label": "Caddy Proxy (Alle Frontends)", "onAutoForward": "openBrowserOnce" },
		"5173": { "label": "Console Frontend", "onAutoForward": "ignore" },
		"5174": { "label": "Platform Frontend", "onAutoForward": "ignore" },
		"5175": { "label": "Docs Frontend", "onAutoForward": "ignore" },
		"5432": { "label": "PostgreSQL (App)", "onAutoForward": "ignore" },
		"5433": { "label": "PostgreSQL (ZITADEL)", "onAutoForward": "ignore" },
		"6379": { "label": "Redis/Dragonfly", "onAutoForward": "ignore" },
		"8080": { "label": "ZITADEL Auth", "onAutoForward": "notify" },
		"9000": { "label": "MinIO S3", "onAutoForward": "ignore" },
		"9001": { "label": "MinIO Console", "onAutoForward": "notify" }
	},

	// Kombiniertes Setup- und Init-Script
	// Beide Commands nutzen das gleiche Script, um nur ein Terminal zu öffnen
	// postCreateCommand: Setup + Init (beim ersten Erstellen)
	// postStartCommand: Nur Init (bei jedem Start, prüft ob Setup bereits gelaufen ist)
	// Nutzt ${containerWorkspaceFolder} für Container, funktioniert auch auf Host mit relativem Pfad
	"postCreateCommand": "bash .devcontainer/setup-and-init.sh || echo '⚠️  Setup script not found or failed, continuing...'",
	"postStartCommand": "bash .devcontainer/setup-and-init.sh || echo '⚠️  Setup script not found or failed, continuing...'",
	// Wir verlassen uns auf direnv, keine manuellen nix develop commands im attach nötig
	// direnv hook wird durch das common-utils Feature gesetzt

	"remoteUser": "vscode"
}
